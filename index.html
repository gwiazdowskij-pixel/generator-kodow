<!DOCTYPE html>
<html lang="pl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GENERATOR KODÓW ESOTIQ & HENDERSON — ONLINE (Firestore)</title>

  <!-- USTAW MOTYW PRZED PIERWSZYM RENDEREM -->
  <script>
    (function(){
      try{
        const k='gh_theme_v1';
        const saved=localStorage.getItem(k);
        const t=(saved==='light'||saved==='dark')?saved:(matchMedia&&matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');
        document.documentElement.setAttribute('data-theme',t);
      }catch(_){}
    })();
  </script>

  <!-- Firebase config (tylko wymagane pola) -->
  <script>
    window.__FIREBASE_CONFIG__ = {
      apiKey: "AIzaSyDd5vjDCwkhSzlcxzmkodc8wpKWW5X8Bdo",
      authDomain: "generator-kodow.firebaseapp.com",
      projectId: "generator-kodow",
      storageBucket: "generator-kodow.firebasestorage.app",
      messagingSenderId: "91160304289",
      appId: "1:91160304289:web:60d306e5c74c7609366ee0"
    };
  </script>

  <style>
    :root{ color-scheme: light dark; }

    /* DARK */
    html[data-theme="dark"]{
      --bg:#0b1020; --bg-elev:#0f152a; --border:#1c2540; --muted:#9fb0c6; --text:#e9edf3;
      --primary:#7dd3fc; --primary-600:#38bdf8; --success:#22c55e; --danger:#f43f5e;
      --focus: 0 0 0 3px rgba(125,211,252,.28);
      --radius:14px; --radius-sm:10px; --shadow: 0 10px 30px rgba(0,0,0,.30), inset 0 1px rgba(255,255,255,.04);
      --inner: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      --input-bg:#0b1224; --chip:#0c1430; --chip-border:#203055; --table-stripe: rgba(255,255,255,.02);
      --header:#101937; --header-text:#d6e7ff; --glass: rgba(10,16,35,.45); --glass-border: rgba(255,255,255,.06);
      --modal-bg:#0a1327; --modal-border:#274077;
      --icon:#e9edf3;

      /* przyciski */
      --btn-bg: linear-gradient(180deg,#111a37,#0e152c);
      --btn-bg-hover: linear-gradient(180deg,#132045,#0e152c);
      --btn-border:#2c3e6c;
      --btn-text: var(--text);

      --btnp-bg: linear-gradient(180deg,var(--primary),var(--primary-600));
      --btnp-border:#0ea5e9;
      --btnp-text:#071019;
    }

    /* LIGHT */
    html[data-theme="light"]{
      --bg:#f6f8fc; --bg-elev:#ffffff; --border:#d9e0ee; --muted:#66789b; --text:#0f172a;
      --primary:#0ea5e9; --primary-600:#0284c7; --success:#16a34a; --danger:#dc2626;
      --focus: 0 0 0 3px rgba(2,132,199,.25);
      --radius:14px; --radius-sm:10px; --shadow: 0 10px 25px rgba(2,6,23,.08), inset 0 1px rgba(255,255,255,.6);
      --inner: linear-gradient(180deg, rgba(2,6,23,.02), rgba(2,6,23,.01));
      --input-bg:#ffffff; --chip:#f1f5ff; --chip-border:#d9e0ee; --table-stripe: rgba(2,6,23,.03);
      --header:#eaf1ff; --header-text:#0f172a; --glass: rgba(255,255,255,.65); --glass-border: rgba(2,6,23,.08);
      --modal-bg:#ffffff; --modal-border:#d9e0ee;
      --icon:#0f172a;

      /* przyciski */
      --btn-bg: linear-gradient(180deg,#ffffff,#f3f7ff);
      --btn-bg-hover: linear-gradient(180deg,#f9fbff,#eef3ff);
      --btn-border:#c7d2fe;
      --btn-text:#0f172a;

      --btnp-bg: linear-gradient(180deg,#38bdf8,#0ea5e9);
      --btnp-border:#0ea5e9;
      --btnp-text:#06121e;
    }

    *{box-sizing:border-box}
    body{ margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background: var(--bg);}
    html[data-theme="dark"] body{
      background:
        radial-gradient(1200px 700px at 8% 0%, #0c1635 0%, var(--bg) 65%),
        radial-gradient(1400px 900px at 100% 100%, #08122a 0%, var(--bg) 60%);
    }

    header{padding:28px 20px 12px}
    .header-inner{max-width:1280px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .appTitle{margin:0; font-weight:800; letter-spacing:.2px}
    .subtitle{margin:6px 0 0; color:var(--muted); font-size:13px}

    .wrap{max-width:1280px;margin:0 auto 48px;padding:0 20px}

    .card{background:var(--inner); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card h2{margin:0; font-size:14px; letter-spacing:.6px; text-transform:uppercase; color:var(--header-text); padding:14px 16px; border-bottom:1px solid var(--border); background:var(--header)}
    .card .body{padding:16px}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    .control{display:flex;flex-direction:column;gap:6px}
    select,input[type=text],input[type=url],input[type=password],textarea,input[type=date]{
      width:100%; padding:12px 12px; border-radius:var(--radius-sm);
      border:1px solid var(--border); background:var(--input-bg); color:var(--text);
      outline:none; transition:border-color .15s, box-shadow .15s, background .15s;
      font-size:14px;
    }
    select:focus, input:focus, textarea:focus{ box-shadow: var(--focus); border-color: var(--primary-600); }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

    .btn{
      appearance:none; border:1px solid var(--btn-border);
      background:var(--btn-bg); color:var(--btn-text);
      padding:10px 14px; border-radius:12px; cursor:pointer;
      font-weight:650; transition:transform .06s, background .18s, border-color .18s;
      display:inline-flex; align-items:center; gap:8px; font-size:14px
    }
    .btn:hover{ background:var(--btn-bg-hover); }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{
      background:var(--btnp-bg); color:var(--btnp-text); border-color:var(--btnp-border)
    }
    .btn-ghost{ background:transparent }

    .themeToggle{
      display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px;
      border:1px solid var(--border); background:var(--bg-elev); cursor:pointer; color:var(--text);
    }
    .themeToggle svg{ width:16px; height:16px; fill:none; stroke: var(--icon); }
    .themeToggle span{ color:var(--text); }

    table{width:100%; border-collapse:separate; border-spacing:0; table-layout:auto}
    thead th{position:sticky; top:0; background:var(--header); color:var(--header-text); border-bottom:1px solid var(--border); font-size:12px; text-transform:uppercase; letter-spacing:.5px}
    th,td{padding:14px 16px; border-bottom:1px solid var(--border); font-size:13px}
    tbody tr:nth-child(even){background:var(--table-stripe)}

    .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(12px); opacity:0; transition: all .25s ease; background:var(--modal-bg); border:1px solid var(--modal-border); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); font-size:14px}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    .pw{position:relative}
    .pw input[type=password], .pw input[type=text]{padding-right:40px}
    .pw-toggle{position:absolute; right:8px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; padding:4px; display:inline-flex; align-items:center; justify-content:center}
    .pw-toggle svg{ width:18px; height:18px; fill:none; stroke:var(--icon); stroke-width:2; }

    /* ukryj natywne 'eye' i 'clear' (Edge) — zapobiega drugiej ikonie */
    input[type="password"]::-ms-reveal,
    input[type="password"]::-ms-clear{ display:none; }
    input::-ms-reveal{ display:none; }

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--bg-elev);font-size:12px;color:var(--text)}

    /* Dialog (pop-up) */
    dialog{ border:1px solid var(--modal-border); border-radius:12px; background:var(--modal-bg); color:var(--text); padding:0; box-shadow:var(--shadow); max-width:460px }
    dialog::backdrop{background:rgba(0,0,0,.45)}
    dialog:focus, dialog:focus-visible{ outline: none; }
    dialog[open]{ display:block; }
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--header)}
    .modal-title{margin:0;font-size:14px;text-transform:uppercase;color:var(--header-text)}
    .modal-body{padding:12px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px solid var(--border)}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1 class="appTitle">GENERATOR KODÓW <span class="brand">ESOTIQ & HENDERSON</span></h1>
        <p class="subtitle">Współdzielone online (Firestore, realtime) — Dark/Light + trwałe logowanie</p>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button id="themeBtn" class="themeToggle" type="button" aria-label="Przełącz motyw">
          <svg id="iconSun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.5-1.5M20.5 20.5L19 19M5 19l-1.5 1.5M20.5 3.5L19 5"></path></svg>
          <svg id="iconMoon" viewBox="0 0 24 24" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
          <span id="themeLabel">Light</span>
        </button>
        <span id="envBadge" class="badge">ENV: …</span>
        <span id="loggedBadge" class="badge" style="display:none"></span>
        <button id="newUserBtn" class="btn" type="button">➕ Nowy użytkownik</button>
        <button id="authBtn" class="btn" type="button"><span id="authLabel">Zaloguj</span></button>
        <button id="openAdmin" class="btn btn-ghost" type="button" style="display:none">Panel admina</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>Utwórz nowy kod</h2>
      <div class="body">
        <div class="row-3">
          <div class="control">
            <label>Marka</label>
            <select id="brand" required>
              <option value="BV">Bloovii (BV)</option>
              <option value="ES" selected>Esotiq (ES)</option>
              <option value="HE">Henderson (HE)</option>
              <option value="HL">Henderson Ladies (HL)</option>
            </select>
          </div>
          <div class="control">
            <label>Asortyment</label>
            <select id="assortment" required>
              <option value="AP">APPLICATION (AP)</option>
              <option value="BT">BUTTON (BT)</option>
              <option value="BX">BOX (BX)</option>
              <option value="EM">EMBROIDERY (EM)</option>
              <option value="FAN">MISCELLANEOUS (FAN)</option>
              <option value="HAN">HANGER PRINT (HAN)</option>
              <option value="HG">HANGTAG (HG)</option>
              <option value="LB">LABEL (LB)</option>
              <option value="PC">SOCKS PACKING (PC)</option>
              <option value="PR" selected>PRINT (PR)</option>
              <option value="PT">PATTERN (PT)</option>
              <option value="RB">RUBBER (RB)</option>
              <option value="ST">PRICE STICKER (ST)</option>
              <option value="TP">TAPE (TP)</option>
              <option value="WCL">WASHING LABEL (WCL)</option>
            </select>
          </div>
          <div class="control">
            <label>Projektant/ka</label>
            <select id="designer" disabled>
              <option value="">— niezalogowano —</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="control"><label>Sezon</label><select id="season" required></select></div>
          <div class="control"><label>Dane kolekcji</label><input type="text" id="collection" placeholder="np. #BARBIE / LINE:SENSUAL / CAPSULE:GEO-LOGIC / GROUP:LACE TOUCH" /></div>
        </div>

        <div class="row" style="margin-top:14px; align-items:center">
          <div class="control">
            <div class="badge">Następny dostępny kod: <strong id="preview">—</strong></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end">
            <button class="btn" id="refresh" type="button">Odśwież</button>
            <button class="btn btn-primary" id="create" type="button">Utwórz kod</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>Historia</h2>
      <div class="body" style="max-height: 520px; overflow: auto; margin:-8px; border-radius: 12px">
        <table id="logTable">
          <thead>
            <tr>
              <th>Kod</th>
              <th>Asortyment</th>
              <th>Marka</th>
              <th>Sezon</th>
              <th>Projektant</th>
              <th>Kolekcja</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- DIALOGI -->
  <dialog id="signupDialog">
    <div class="modal-header">
      <h3 class="modal-title">Nowy użytkownik</h3>
    </div>
    <div class="modal-body">
      <div class="control"><label>Nazwa użytkownika</label><input id="suUser" type="text" placeholder="np. zuza.kowalska" required /></div>
      <div class="row" style="margin-top:8px">
        <div class="control"><label>Imię <span style="color:var(--danger)">*</span></label><input id="suFirst" type="text" required /></div>
        <div class="control"><label>Nazwisko <span style="color:var(--danger)">*</span></label><input id="suLast" type="text" required /></div>
      </div>
      <div id="suError" class="hint" style="color:#fca5a5; display:none; margin-top:6px"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close>Anuluj</button>
      <button id="suNext" class="btn btn-primary" type="button">Dalej</button>
    </div>
  </dialog>

  <dialog id="loginDialog">
    <div class="modal-header">
      <h3 class="modal-title">Logowanie</h3>
    </div>
    <div class="modal-body">
      <div class="control"><label>Użytkownik</label><select id="loginUser"></select></div>
      <div class="control" style="margin-top:8px">
        <label>Hasło</label>
        <div class="pw">
          <input id="loginPass" type="password" placeholder="Wpisz hasło" />
          <button type="button" class="pw-toggle" data-target="loginPass" aria-label="Pokaż/ukryj hasło">
            <svg data-eye="closed" viewBox="0 0 24 24"><path d="M3 3l18 18"></path><path d="M10 4.5c.65-.33 1.35-.5 2-.5 7 0 11 7 11 7a17.9 17.9 0 0 1-2.1 2.79M2 12s1.37-2.6 3.9-4.67M12 9a3 3 0 0 0-3 3"></path></svg>
            <svg data-eye="open" viewBox="0 0 24 24" style="display:none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      <div id="loginError" class="hint" style="color:#fca5a5; display:none; margin-top:6px">Błędne dane logowania.</div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close>Anuluj</button>
      <button id="loginSubmit" class="btn btn-primary" type="button">Zaloguj</button>
    </div>
  </dialog>

  <dialog id="setPwdDialog">
    <div class="modal-header"><h3 class="modal-title">Ustaw nowe hasło</h3></div>
    <div class="modal-body">
      <p class="hint">Hasło: min. 8 znaków</p>
      <div class="control">
        <label>Nowe hasło</label>
        <div class="pw">
          <input id="newPwd" type="password" maxlength="64" autocomplete="new-password" />
          <button type="button" class="pw-toggle" data-target="newPwd" aria-label="Pokaż/ukryj hasło">
            <svg data-eye="closed" viewBox="0 0 24 24"><path d="M3 3l18 18"></path><path d="M10 4.5c.65-.33 1.35-.5 2-.5 7 0 11 7 11 7a17.9 17.9 0 0 1-2.1 2.79M2 12s1.37-2.6 3.9-4.67M12 9a3 3 0 0 0-3 3"></path></svg>
            <svg data-eye="open" viewBox="0 0 24 24" style="display:none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      <div class="control">
        <label>Powtórz hasło</label>
        <div class="pw">
          <input id="newPwd2" type="password" maxlength="64" autocomplete="new-password" />
          <button type="button" class="pw-toggle" data-target="newPwd2" aria-label="Pokaż/ukryj hasło">
            <svg data-eye="closed" viewBox="0 0 24 24"><path d="M3 3l18 18"></path><path d="M10 4.5c.65-.33 1.35-.5 2-.5 7 0 11 7 11 7a17.9 17.9 0 0 1-2.1 2.79M2 12s1.37-2.6 3.9-4.67M12 9a3 3 0 0 0-3 3"></path></svg>
            <svg data-eye="open" viewBox="0 0 24 24" style="display:none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      <div id="setPwdError" class="hint" style="color:#fca5a5; display:none; margin-top:6px"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close>Anuluj</button>
      <button id="setPwdSave" class="btn btn-primary" type="button">Zapisz</button>
    </div>
  </dialog>

  <dialog id="adminDialog">
    <div class="modal-header"><h3 class="modal-title">Panel administratora</h3></div>
    <div class="modal-body">
      <p class="hint">Zresetuj hasło użytkownika (ustawi puste hasło i wymusi zmianę przy następnym logowaniu).</p>
      <div id="adminList" class="chips" style="margin-top:8px"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close>Zamknij</button>
    </div>
  </dialog>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, addDoc, query, orderBy, onSnapshot, runTransaction,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const $ = id => document.getElementById(id);
    const themeBtn = $('themeBtn'); const themeLabel = $('themeLabel');
    const iconSun = $('iconSun'); const iconMoon = $('iconMoon');
    const envBadge = $('envBadge'); const toast = $('toast');
    const brandEl = $('brand'); const assortmentEl = $('assortment'); const designerEl = $('designer'); const seasonEl = $('season'); const collectionEl = $('collection'); const previewEl = $('preview'); const refreshBtn = $('refresh'); const createBtn = $('create'); const logBody = $('logBody');
    const newUserBtn = $('newUserBtn'); const signupDialog = $('signupDialog'); const suUser = $('suUser'); const suFirst = $('suFirst'); const suLast = $('suLast'); const suError = $('suError'); const suNext = $('suNext');
    const loginDialog = $('loginDialog'); const loginUserEl = $('loginUser'); const loginPassEl = $('loginPass'); const loginError = $('loginError'); const loginSubmit = $('loginSubmit');
    const setPwdDialog = $('setPwdDialog'); const newPwd = $('newPwd'); const newPwd2 = $('newPwd2'); const setPwdError = $('setPwdError'); const setPwdSave = $('setPwdSave');
    const authBtn = $('authBtn'); const authLabel = $('authLabel'); const openAdmin = $('openAdmin'); const adminList = $('adminList'); const loggedBadge = $('loggedBadge');

    /* THEME */
    const THEME_KEY='gh_theme_v1';
    function setTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      const light = t==='light';
      iconSun.style.display = light ? 'none' : '';
      iconMoon.style.display = light ? '' : 'none';
      themeLabel.textContent = light ? 'Dark' : 'Light';
      try{ localStorage.setItem(THEME_KEY, t); }catch(_){}
    }
    (function initTheme(){
      try{
        const saved = localStorage.getItem(THEME_KEY);
        const t=(saved==='light'||saved==='dark')?saved:(document.documentElement.getAttribute('data-theme')||'dark');
        setTheme(t);
      }catch(_){ setTheme(document.documentElement.getAttribute('data-theme')||'dark'); }
    })();
    themeBtn.addEventListener('click', ()=>{
      const cur=document.documentElement.getAttribute('data-theme')||'dark';
      setTheme(cur==='dark'?'light':'dark');
    });

    /* UTIL */
    const pad3 = n => String(n).padStart(3,'0');
    const sha256Hex = async (text)=>{ const enc = new TextEncoder().encode(text); const buf = await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); };
    const showToast = (m)=>{ if(!toast) return; toast.textContent = m; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.classList.remove('show'),1600); };

    /* AUTH PERSIST */
    const AUTH_KEY='gh_auth_v1';
    const loadAuth = ()=>{ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)) || {user:'',role:''}; }catch{ return {user:'',role:''}; } };
    const saveAuth = (auth)=>{ try{ localStorage.setItem(AUTH_KEY, JSON.stringify(auth)); }catch{} };
    let AUTH = loadAuth();

    /* Firebase */
    const app = initializeApp(window.__FIREBASE_CONFIG__||{});
    const db  = getFirestore(app);
    envBadge.textContent = 'ENV: FIREBASE (online, współdzielone — realtime)';

    /* MAPY / STAN */
    const BRAND_MAP = { ES:'Esotiq', HE:'Henderson', BV:'Bloovii', HL:'Henderson Ladies' };
    const ASSORTMENT_MAP = { PR:'PRINT', PT:'PATTERN', EM:'EMBROIDERY', RB:'RUBBER', TP:'TAPE', AP:'APPLICATION', LB:'LABEL', HG:'HANGTAG', BX:'BOX', PC:'SOCKS PACKING', ST:'PRICE STICKER', FAN:'MISCELLANEOUS', BT:'BUTTON', HAN:'HANGER PRINT', WCL:'WASHING LABEL' };
    const usersCol = collection(db, 'users');
    const codesCol = collection(db, 'codes');
    const countersDoc = doc(db, 'meta', 'counters');

    const USERS = new Map();   // id -> user data
    let LAST_CODES = [];       // ostatnie pobrane dokumenty 'codes'
    let DID_CLEAR_TEST_USERS = false; // jednorazowe czyszczenie wszystkich projektantów

    // Startowe wartości dla BLOOVII / ESOTIQ / HENDERSON / HENDERSON LADIES
    // (ostatnio użyte numery – generator zaczyna od +1, żeby pierwszy nowy kod był tym podanym)
    const INITIAL_START = {
      /* BLOOVII (BV) */
      'PR_BV': 164,  // → PR_BV165
      'PT_BV': 83,   // → PT_BV084
      'EM_BV': 41,   // → EM_BV042
      'RB_BV': 19,   // RUB_BV020 → RB_BV020
      'TP_BV': 1,    // → TP_BV002
      'AP_BV': 9,    // → AP_BV010
      'LB_BV': 54,   // → LB_BV055
      'HG_BV': 13,   // → HG_BV014
      'ST_BV': 1,    // → ST_BV002
      'PC_BV': 2,    // → PC_BV003
      'BX_BV': 5,    // → BX_BV006
      'FAN_BV':7,    // → FAN_BV008
      'BT_BV': 1,    // → BT_BV002
      'HAN_BV':1,    // → HAN_BV002
      'WCL_BV':2,    // → WCL_BV003

      /* ESOTIQ (ES) */
      'PR_ES': 471,  // PR_ES472
      'PT_ES': 840,  // PT_ES841
      'EM_ES': 132,  // EM_ES133
      'RB_ES': 186,  // RUB_ES187 → RB_ES187
      'TP_ES': 12,   // TP_ES013
      'AP_ES': 142,  // AP_ES143
      'LB_ES': 149,  // LB_ES150
      'HG_ES': 157,  // HG_ES158
      'ST_ES': 64,   // ST_ES065
      'PC_ES': 0,    // PC_ES001
      'BX_ES': 233,  // BX_ES234
      'FAN_ES':95,   // FAN_ES096
      'BT_ES': 4,    // BT_ES005 (BT-ES005)
      'HAN_ES':0,    // HAN_ES001
      'WCL_ES':0,    // WCL_ES001

      /* HENDERSON (HE) */
      'PR_HE': 761,  // PR_HE762
      'PT_HE': 906,  // PT_HE907
      'EM_HE': 101,  // EM_HE102 (EM-HE102)
      'RB_HE': 653,  // RUB_HE654 → RB_HE654
      'TP_HE': 19,   // TP_HE020
      'AP_HE': 1,    // AP_HE002
      'LB_HE': 505,  // LB_HE506
      'HG_HE': 57,   // HG_HE058
      'PC_HE': 0,    // PC_HE001
      'ST_HE': 160,  // ST_HE161
      'BX_HE': 270,  // BX_HE271
      'FAN_HE':16,   // FAN_HE017
      'BT_HE': 0,    // BT_HE001
      'HAN_HE':0,    // HAN_HE001
      'WCL_HE':24,   // WCL_HE025

      /* HENDERSON LADIES (HL) */
      'PR_HL': 435,  // PR_HL436
      'PT_HL': 443,  // PT_HL444
      'EM_HL': 19,   // EM_HL020
      'RB_HL': 19,   // RUB_HL020 → RB_HL020
      'TP_HL': 0,    // TP_HL001
      'AP_HL': 18,   // AP_HL019
      'LB_HL': 44,   // LB_HL045
      'HG_HL': 10,   // HG_HL011
      'ST_HL': 13,   // traktujemy ST_HL014 jako next → start=13
      'PC_HL': 0,    // PC_HL001
      'BX_HL': 44,   // BX_HL045
      'FAN_HL':0,    // FAN_HL001
      'BT_HL': 1,    // BT_HL002
      'HAN_HL':0,    // HAN_HL001
      'WCL_HL':0     // WCL_HL001
    };

    /* AUTH UI */
    function updateAuthUI(){
      const logged = !!AUTH.user;
      authLabel.textContent = logged ? 'Wyloguj' : 'Zaloguj';
      openAdmin.style.display = AUTH.role==='admin' ? 'inline-flex' : 'none';
      if (designerEl){
        designerEl.innerHTML = logged && AUTH.role==='user'
          ? `<option>${AUTH.user}</option>`
          : '<option value="">— niezalogowano —</option>';
        designerEl.disabled = true;
      }
      if (loggedBadge){
        if (logged) {
          loggedBadge.style.display='inline-flex';
          loggedBadge.textContent = `Zalogowany: ${AUTH.user}${AUTH.role==='admin'?' (admin)':''}`;
        } else {
          loggedBadge.style.display='none';
          loggedBadge.textContent='';
        }
      }
    }

    /* USERS realtime + JEDNORAZOWE CZYSZCZENIE + ponowne renderowanie */
    const fullName = (u)=> [u.first||'', u.last||''].filter(Boolean).join(' ').trim();

    function renderCodes(){
      logBody.innerHTML='';
      const arr = LAST_CODES.slice().reverse();
      arr.forEach(item=>{
        const u = USERS.get(item.designer);
        const who = item.designerName || (u && fullName(u)) || item.designer;
        const dt = (item.createdAt && typeof item.createdAt.toDate==='function') ? item.createdAt.toDate() :
                   (typeof item.createdAt==='number'||typeof item.createdAt==='string') ? new Date(item.createdAt) : new Date();
        const tr=document.createElement('tr');
        tr.innerHTML = `<td><strong>${item.code}</strong></td>
          <td>${ASSORTMENT_MAP[item.assortment]||item.assortment}</td>
          <td>${BRAND_MAP[item.brand]||item.brand}</td>
          <td>${item.season}</td>
          <td>${who}</td>
          <td>${item.collection||''}</td>
          <td>${dt.toLocaleString()}</td>`;
        logBody.appendChild(tr);
      });
    }

    function subscribeUsers(){
      const qUsers = query(usersCol, orderBy('id'));
      onSnapshot(qUsers, async snap=>{
        const arr = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        // JEDNORAZOWE "WYCZYSZCZENIE" LISTY PROJEKTANTÓW:
        if (!DID_CLEAR_TEST_USERS && arr.length > 0) {
          DID_CLEAR_TEST_USERS = true;
          const toDelete = arr.filter(u => u.id !== 'administrator');
          if (toDelete.length > 0) {
            try {
              await Promise.all(
                toDelete.map(u => deleteDoc(doc(db, 'users', u.id)))
              );
            } catch(e) {
              console.error('Błąd przy kasowaniu starych użytkowników', e);
            }
            return; // poczekaj na kolejny snapshot po usunięciu
          }
        }

        USERS.clear();
        arr.forEach(u=> USERS.set(u.id, u));

        if (arr.length === 0) {
          loginUserEl.innerHTML = `<option value="administrator">administrator</option>`;
        } else {
          loginUserEl.innerHTML =
            arr.map(u=>`<option value="${u.id}">${u.id}</option>`).join('') +
            '<option value="administrator">administrator</option>';
        }

        renderCodes();
      });
    }

    /* CODES realtime */
    function subscribeCodes(){
      const qCodes = query(codesCol, orderBy('createdAt','asc'));
      onSnapshot(qCodes, snap=>{
        LAST_CODES = snap.docs.map(d=> d.data());
        renderCodes();
      });
    }

    /* Sezony / podgląd */
    function buildSeasons(){
      const now = new Date(); const y = now.getFullYear(); const years=[y,y+1,y+2]; const opts=[];
      years.forEach(yr=>{ opts.push(`SS${yr}`); opts.push(`AW${yr}`); });
      seasonEl.innerHTML = opts.map(s=>`<option>${s}</option>`).join('');
      seasonEl.value = (now.getMonth()>=8) ? `AW${y}` : `SS${y}`;
    }
    function computePreview(){ previewEl.textContent = `${assortmentEl.value}_${brandEl.value}…`; }

    /* Create code (z designerName + start dla wszystkich marek) */
    async function createCode(){
      if(!AUTH.user || AUTH.role!=='user'){ alert('Zaloguj się jako projektant/ka.'); return; }
      const a = assortmentEl.value; const b = brandEl.value; const s = seasonEl.value; const coll = (collectionEl.value||'').trim();
      const key = `${a}_${b}`;

      const seq = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(countersDoc);
        const data = snap.exists()?snap.data():{};
        let current = data[key];
        if (current == null) {
          current = INITIAL_START[key] ?? 0;
        }
        const next = Number(current) + 1;
        tx.set(countersDoc, Object.assign({}, data, { [key]: next }));
        return next;
      });

      const code = `${a}_${b}${pad3(seq)}`;
      const u = USERS.get(AUTH.user)||{};
      const entry = {
        code,
        assortment:a,
        brand:b,
        season:s,
        designer:AUTH.user,
        designerName: fullName(u)||AUTH.user,
        collection:coll,
        createdAt: serverTimestamp()
      };
      await addDoc(codesCol, entry);
      computePreview(); showToast('Utworzono: '+code);
      try{ await navigator.clipboard.writeText(code); }catch{}
    }

    /* Signup */
    const validUsername = (u)=> /^[a-z][a-z0-9_.\-]{2,31}$/i.test(u);
    newUserBtn.addEventListener('click', ()=>{
      suError.style.display='none'; suUser.value=''; suFirst.value=''; suLast.value='';
      signupDialog.showModal(); suUser.focus();
    });
    suNext.addEventListener('click', async ()=>{
      const id = suUser.value.trim(), first = suFirst.value.trim(), last = suLast.value.trim();
      if(!validUsername(id)){ suError.textContent='Użyj formatu: litera na start, 3–32 znaki (litery/cyfry . _ -)'; suError.style.display='block'; return; }
      if(first.length===0 || last.length===0){ suError.textContent='Imię i nazwisko są obowiązkowe.'; suError.style.display='block'; return; }
      try{
        const ref = doc(db,'users',id); const s=await getDoc(ref);
        if(s.exists()){ suError.textContent='Taki użytkownik już istnieje.'; suError.style.display='block'; return; }
        await setDoc(ref,{ id, first, last, pass:'', forceReset:true, role:'user', createdAt: serverTimestamp() });
        signupDialog.close(); setPwdDialog.dataset.pendingUser=id; newPwd.value=''; newPwd2.value=''; setPwdError.style.display='none'; setPwdDialog.showModal();
      }catch(e){ suError.textContent='Nie udało się utworzyć użytkownika.'; suError.style.display='block'; }
    });

    /* Login / Password */
    function setLoggedIn(u,role){ AUTH={user:u,role}; saveAuth(AUTH); updateAuthUI(); showToast('Zalogowano.'); }
    function setLoggedOut(){ AUTH={user:'',role:''}; saveAuth(AUTH); updateAuthUI(); showToast('Wylogowano.'); }

    authBtn.addEventListener('click', ()=>{ if(AUTH.user){ setLoggedOut(); return; } loginError.style.display='none'; loginPassEl.value=''; loginDialog.showModal(); });
    document.querySelectorAll('dialog [data-close]').forEach(b=> b.addEventListener('click', e=> e.target.closest('dialog').close()));

    loginSubmit.addEventListener('click', async ()=>{
      const id = loginUserEl.value; const pass = loginPassEl.value;
      if(id==='administrator'){
        if(pass==='mars'){ loginDialog.close(); setLoggedIn(id,'admin'); } else { loginError.style.display='block'; }
        return;
      }
      const s = await getDoc(doc(db,'users',id)); if(!s.exists()){ loginError.style.display='block'; return; }
      const u = s.data();
      if(u.forceReset){
        if(pass==='Atlas123'){ loginDialog.close(); setPwdDialog.dataset.pendingUser=id; newPwd.value=''; newPwd2.value=''; setPwdError.style.display='none'; setPwdDialog.showModal(); }
        else { loginError.style.display='block'; }
        return;
      }
      const hash = await sha256Hex(pass);
      if(u.pass===hash){ loginDialog.close(); setLoggedIn(id,'user'); } else { loginError.style.display='block'; }
    });

    setPwdSave.addEventListener('click', async ()=>{
      const u = setPwdDialog.dataset.pendingUser||''; const p1=newPwd.value; const p2=newPwd2.value;
      if(p1.length<8 || p1!==p2){ setPwdError.textContent='Hasła muszą być identyczne i mieć min. 8 znaków.'; setPwdError.style.display='block'; return; }
      const hash = await sha256Hex(p1); await updateDoc(doc(db,'users',u), { pass:hash, forceReset:false }); setPwdDialog.close(); setLoggedIn(u,'user');
    });

    /* Admin reset */
    openAdmin.addEventListener('click', ()=>{
      const html = Array.from(USERS.keys())
        .filter(u=>u!=='administrator')
        .map(u=>`<span class="chip" data-u="${u}"><strong>${u}</strong> <button class="btn" data-reset="${u}">Reset</button></span>`)
        .join('');
      adminList.innerHTML = html; $('adminDialog').showModal();
    });
    adminList.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-reset]'); if(!btn) return;
      await updateDoc(doc(db,'users',btn.getAttribute('data-reset')), { pass:'', forceReset:true }); showToast('Zresetowano hasło.');
    });

    /* Sezony / podgląd / subskrypcje */
    function buildSeasonsAndPreview(){
      buildSeasons(); computePreview();
      brandEl.addEventListener('change', computePreview);
      assortmentEl.addEventListener('change', computePreview);
      refreshBtn.addEventListener('click', computePreview);
    }
    createBtn.addEventListener('click', createCode);

    /* Jedna ikona „oko” – logika przełączania */
    function toggleEye(btn, visible){
      const c=btn.querySelector('svg[data-eye="closed"]'), o=btn.querySelector('svg[data-eye="open"]');
      if(c&&o){ c.style.display = visible?'none':''; o.style.display = visible?'':'none'; }
    }
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.pw-toggle'); if(!btn) return;
      const id = btn.getAttribute('data-target'); const inp = document.getElementById(id); if(!inp) return;
      const nowVisible = (inp.type==='password'); inp.type = nowVisible?'text':'password'; toggleEye(btn, nowVisible);
    });

    /* Init */
    (function init(){
      buildSeasonsAndPreview();
      subscribeUsers();     // czyta użytkowników + jednorazowo czyści testowych
      subscribeCodes();     // czyta kody
      updateAuthUI();
    })();
  </script>
</body>
</html>
