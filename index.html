<!DOCTYPE html>
<html lang="pl" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GENERATOR KODÓW ESOTIQ & HENDERSON — ONLINE (Firestore)</title>

  <!-- Twoja konfiguracja Firebase (TYLKO wymagane pola) -->
  <script>
    window.__FIREBASE_CONFIG__ = {
      apiKey: "AIzaSyDd5vjDCwkhSzlcxzmkodc8wpKWW5X8Bdo",
      authDomain: "generator-kodow.firebaseapp.com",
      projectId: "generator-kodow",
      storageBucket: "generator-kodow.firebasestorage.app",
      messagingSenderId: "91160304289",
      appId: "1:91160304289:web:60d306e5c74c7609366ee0"
    };
  </script>

  <style>
    :root{ color-scheme: light dark; }
    html[data-theme="dark"]{
      --bg:#0b1020; --bg-elev:#0f152a; --border:#1c2540; --muted:#9fb0c6; --text:#e9edf3;
      --primary:#7dd3fc; --primary-600:#38bdf8; --success:#22c55e; --danger:#f43f5e;
      --focus: 0 0 0 3px rgba(125,211,252,.28);
      --radius:14px; --radius-sm:10px; --shadow: 0 10px 30px rgba(0,0,0,.30), inset 0 1px rgba(255,255,255,.04);
      --inner: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      --input-bg:#0b1224; --chip:#0c1430; --chip-border:#203055; --table-stripe: rgba(255,255,255,.02);
      --header:#101937; --header-text:#d6e7ff; --glass: rgba(10,16,35,.45); --glass-border: rgba(255,255,255,.06);
      --modal-bg:#0a1327; --modal-border:#274077;
      --icon:#e9edf3;
    }
    html[data-theme="light"]{
      --bg:#f6f8fc; --bg-elev:#ffffff; --border:#d9e0ee; --muted:#66789b; --text:#0f172a;
      --primary:#0ea5e9; --primary-600:#0284c7; --success:#16a34a; --danger:#dc2626;
      --focus: 0 0 0 3px rgba(2,132,199,.25);
      --radius:14px; --radius-sm:10px; --shadow: 0 10px 25px rgba(2,6,23,.08), inset 0 1px rgba(255,255,255,.6);
      --inner: linear-gradient(180deg, rgba(2,6,23,.02), rgba(2,6,23,.01));
      --input-bg:#ffffff; --chip:#f1f5ff; --chip-border:#d9e0ee; --table-stripe: rgba(2,6,23,.03);
      --header:#eaf1ff; --header-text:#0f172a; --glass: rgba(255,255,255,.65); --glass-border: rgba(2,6,23,.08);
      --modal-bg:#ffffff; --modal-border:#d9e0ee;
      --icon:#0f172a;
    }

    *{box-sizing:border-box}
    body{ margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background: var(--bg);}
    html[data-theme="dark"] body{
      background:
        radial-gradient(1200px 700px at 8% 0%, #0c1635 0%, var(--bg) 65%),
        radial-gradient(1400px 900px at 100% 100%, #08122a 0%, var(--bg) 60%);
    }

    header{padding:28px 20px 12px}
    .header-inner{max-width:1280px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .appTitle{margin:0; font-weight:800; letter-spacing:.2px}
    .subtitle{margin:6px 0 0; color:var(--muted); font-size:13px}

    .wrap{max-width:1280px;margin:0 auto 48px;padding:0 20px}

    .card{background:var(--inner); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .card h2{margin:0; font-size:14px; letter-spacing:.6px; text-transform:uppercase; color:var(--header-text); padding:14px 16px; border-bottom:1px solid var(--border); background:var(--header)}
    .card .body{padding:16px}

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    .control{display:flex;flex-direction:column;gap:6px}
    select,input[type=text],input[type=url],input[type=password],textarea,input[type=date]{
      width:100%; padding:12px 12px; border-radius:var(--radius-sm);
      border:1px solid var(--border); background:var(--input-bg); color:var(--text);
      outline:none; transition:border-color .15s, box-shadow .15s, background .15s;
      font-size:14px;
    }
    select:focus, input:focus, textarea:focus{ box-shadow: var(--focus); border-color: var(--primary-600); }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

    .btn{appearance:none; border:1px solid var(--border); background:linear-gradient(180deg,#111a37,#0e152c); color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:650; transition:transform .06s, background .18s, border-color .18s; display:inline-flex; align-items:center; gap:8px; font-size:14px}
    .btn:hover{background:linear-gradient(180deg,#132045,#0e152c); border-color:#2c3e6c}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(180deg,var(--primary),var(--primary-600)); color:#071019; border-color:#0ea5e9}
    .btn-ghost{background:transparent}

    .themeToggle{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; border:1px solid var(--border); background:var(--bg-elev); cursor:pointer; }
    .themeToggle svg{ width:16px; height:16px; fill: none; stroke: var(--icon); }

    table{width:100%; border-collapse:separate; border-spacing:0; table-layout:auto}
    thead th{position:sticky; top:0; background:var(--header); color:var(--header-text); border-bottom:1px solid var(--border); font-size:12px; text-transform:uppercase; letter-spacing:.5px}
    th,td{padding:14px 16px; border-bottom:1px solid var(--border); font-size:13px}
    tbody tr:nth-child(even){background:var(--table-stripe)}

    .toast{position:fixed; bottom:16px; left:50%; transform:translateX(-50%) translateY(12px); opacity:0; transition: all .25s ease; background:var(--modal-bg); border:1px solid var(--modal-border); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); font-size:14px}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    .pw{position:relative}
    .pw input[type=password], .pw input[type=text]{padding-right:40px}
    .pw-toggle{position:absolute; right:8px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; padding:4px; display:inline-flex; align-items:center; justify-content:center}
    .pw-toggle svg{ width:18px; height:18px; fill:none; stroke:var(--icon); stroke-width:2; }

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--bg-elev);font-size:12px;color:var(--text)}

    /* Dialog (pop-up) – spójny z Dark/Light, bez białej obwódki */
    dialog{ border:1px solid var(--modal-border); border-radius:12px; background:var(--modal-bg); color:var(--text); padding:0; box-shadow:var(--shadow); max-width:460px }
    dialog::backdrop{background:rgba(0,0,0,.45)}
    dialog:focus{ outline: none; }
    dialog:focus-visible{ outline: none; }
    dialog[open]{ display:block; }
    .modal-header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);background:var(--header)}
    .modal-title{margin:0;font-size:14px;text-transform:uppercase;color:var(--header-text)}
    .modal-body{padding:12px}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px solid var(--border)}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div>
        <h1 class="appTitle">GENERATOR KODÓW <span class="brand">ESOTIQ & HENDERSON</span></h1>
        <p class="subtitle">Współdzielone online (Firestore, realtime) — Dark/Light + trwałe logowanie</p>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        <button id="themeBtn" class="themeToggle" type="button" aria-label="Przełącz motyw">
          <svg id="iconSun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.5-1.5M20.5 20.5L19 19M5 19l-1.5 1.5M20.5 3.5L19 5"></path></svg>
          <svg id="iconMoon" viewBox="0 0 24 24" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
          <span id="themeLabel">Light</span>
        </button>
        <span id="envBadge" class="badge">ENV: …</span>
        <span id="loggedBadge" class="badge" style="display:none"></span>
        <button id="newUserBtn" class="btn" type="button">➕ Nowy użytkownik</button>
        <button id="authBtn" class="btn" type="button"><span id="authLabel">Zaloguj</span></button>
        <button id="openAdmin" class="btn btn-ghost" type="button" style="display:none">Panel admina</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <section class="card">
      <h2>Utwórz nowy kod</h2>
      <div class="body">
        <div class="row-3">
          <div class="control">
            <label>Marka</label>
            <select id="brand" required>
              <option value="BV">Bloovii (BV)</option>
              <option value="ES" selected>Esotiq (ES)</option>
              <option value="HE">Henderson (HE)</option>
              <option value="HL">Henderson Ladies (HL)</option>
            </select>
          </div>
          <div class="control">
            <label>Asortyment</label>
            <select id="assortment" required>
              <option value="AP">APPLICATION (AP)</option>
              <option value="BT">BUTTON (BT)</option>
              <option value="BX">BOX (BX)</option>
              <option value="EM">EMBROIDERY (EM)</option>
              <option value="FAN">MISCELLANEOUS (FAN)</option>
              <option value="HAN">HANGER PRINT (HAN)</option>
              <option value="HG">HANGTAG (HG)</option>
              <option value="LB">LABEL (LB)</option>
              <option value="PC">SOCKS PACKING (PC)</option>
              <option value="PR" selected>PRINT (PR)</option>
              <option value="PT">PATTERN (PT)</option>
              <option value="RB">RUBBER (RB)</option>
              <option value="ST">PRICE STICKER (ST)</option>
              <option value="TP">TAPE (TP)</option>
              <option value="WCL">WASHING LABEL (WCL)</option>
            </select>
          </div>
          <div class="control">
            <label>Projektant/ka</label>
            <select id="designer" disabled>
              <option value="">— niezalogowano —</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:14px">
          <div class="control"><label>Sezon</label><select id="season" required></select></div>
          <div class="control"><label>Dane kolekcji</label><input type="text" id="collection" placeholder="np. #BARBIE / LINE:SENSUAL / CAPSULE:GEO-LOGIC / GROUP:LACE TOUCH" /></div>
        </div>

        <div class="row" style="margin-top:14px; align-items:center">
          <div class="control">
            <div class="badge">Następny dostępny kod: <strong id="preview">—</strong></div>
          </div>
          <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end">
            <button class="btn" id="refresh" type="button">Odśwież</button>
            <button class="btn btn-primary" id="create" type="button">Utwórz kod</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>Historia</h2>
      <div class="body" style="max-height: 520px; overflow: auto; margin:-8px; border-radius: 12px">
        <table id="logTable">
          <thead>
            <tr>
              <th>Kod</th>
              <th>Asortyment</th>
              <th>Marka</th>
              <th>Sezon</th>
              <th>Projektant</th>
              <th>Kolekcja</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- DIALOGI (pop-up) -->
  <dialog id="signupDialog">
    <div class="modal-header">
      <h3 class="modal-title">Nowy użytkownik</h3>
      <button class="btn btn-ghost" type="button" data-close>Zamknij</button>
    </div>
    <div class="modal-body">
      <div class="control"><label>Nazwa użytkownika</label><input id="suUser" type="text" placeholder="np. zuza.kowalska" required /></div>
      <div class="row" style="margin-top:8px">
        <div class="control"><label>Imię <span style="color:var(--danger)">*</span></label><input id="suFirst" type="text" required /></div>
        <div class="control"><label>Nazwisko <span style="color:var(--danger)">*</span></label><input id="suLast" type="text" required /></div>
      </div>
      <div id="suError" class="hint" style="color:#fca5a5; display:none; margin-top:6px"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close>Anuluj</button>
      <button id="suNext" class="btn btn-primary" type="button">Dalej</button>
    </div>
  </dialog>

  <dialog id="loginDialog">
    <div class="modal-header">
      <h3 class="modal-title">Logowanie</h3>
      <button class="btn btn-ghost" type="button" data-close>Zamknij</button>
    </div>
    <div class="modal-body">
      <div class="control"><label>Użytkownik</label><select id="loginUser"></select></div>
      <div class="control" style="margin-top:8px">
        <label>Hasło</label>
        <div class="pw">
          <input id="loginPass" type="password" placeholder="Wpisz hasło" />
          <button type="button" class="pw-toggle" data-target="loginPass" aria-label="Pokaż/ukryj hasło">
            <!-- Oko zamknięte (domyślnie) -->
            <svg data-eye="closed" viewBox="0 0 24 24"><path d="M3 3l18 18"></path><path d="M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42M9.88 5.088A10.36 10.36 0 0 1 12 5c5 0 9 4.5 10 7- .27.6-.66 1.23-1.14 1.86M6.23 6.23C4.23 7.46 2.86 9.06 2 12c.38.85.88 1.65 1.49 2.39"></path></svg>
            <!-- Oko otwarte -->
            <svg data-eye="open" viewBox="0 0 24 24" style="display:none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      <div id="loginError" class="hint" style="color:#fca5a5; display:none; margin-top:6px">Błędne dane logowania.</div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close>Anuluj</button>
      <button id="loginSubmit" class="btn btn-primary" type="button">Zaloguj</button>
    </div>
  </dialog>

  <dialog id="setPwdDialog">
    <div class="modal-header">
      <h3 class="modal-title">Ustaw nowe hasło</h3>
    </div>
    <div class="modal-body">
      <p class="hint">Hasło: min. 8 znaków</p>
      <div class="control">
        <label>Nowe hasło</label>
        <div class="pw">
          <input id="newPwd" type="password" maxlength="64" />
          <button type="button" class="pw-toggle" data-target="newPwd" aria-label="Pokaż/ukryj hasło">
            <svg data-eye="closed" viewBox="0 0 24 24"><path d="M3 3l18 18"></path><path d="M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42M9.88 5.088A10.36 10.36 0 0 1 12 5c5 0 9 4.5 10 7- .27.6-.66 1.23-1.14 1.86M6.23 6.23C4.23 7.46 2.86 9.06 2 12c.38.85.88 1.65 1.49 2.39"></path></svg>
            <svg data-eye="open" viewBox="0 0 24 24" style="display:none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      <div class="control">
        <label>Powtórz hasło</label>
        <div class="pw">
          <input id="newPwd2" type="password" maxlength="64" />
          <button type="button" class="pw-toggle" data-target="newPwd2" aria-label="Pokaż/ukryj hasło">
            <svg data-eye="closed" viewBox="0 0 24 24"><path d="M3 3l18 18"></path><path d="M10.58 10.58A3 3 0 0 0 12 15a3 3 0 0 0 2.42-4.42M9.88 5.088A10.36 10.36 0 0 1 12 5c5 0 9 4.5 10 7- .27.6-.66 1.23-1.14 1.86M6.23 6.23C4.23 7.46 2.86 9.06 2 12c.38.85.88 1.65 1.49 2.39"></path></svg>
            <svg data-eye="open" viewBox="0 0 24 24" style="display:none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>
          </button>
        </div>
      </div>
      <div id="setPwdError" class="hint" style="color:#fca5a5; display:none; margin-top:6px"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" type="button" data-close>Anuluj</button>
      <button id="setPwdSave" class="btn btn-primary" type="button">Zapisz</button>
    </div>
  </dialog>

  <dialog id="adminDialog">
    <div class="modal-header"><h3 class="modal-title">Panel administratora</h3><button class="btn btn-ghost" type="button" data-close>Zamknij</button></div>
    <div class="modal-body"><p class="hint">Zresetuj hasło użytkownika (ustawi puste hasło i wymusi zmianę przy następnym logowaniu).</p><div id="adminList" class="chips" style="margin-top:8px"></div></div>
    <div class="modal-actions"><button class="btn" type="button" data-close>Zamknij</button></div>
  </dialog>

  <script type="module">
    // ===== Firebase (ESM z CDN) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, query, orderBy, onSnapshot, runTransaction,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // ===== DOM =====
    const $ = id => document.getElementById(id);
    const themeBtn = $('themeBtn'); const themeLabel = $('themeLabel');
    const iconSun = $('iconSun'); const iconMoon = $('iconMoon');
    const envBadge = $('envBadge'); const toast = $('toast');
    const brandEl = $('brand'); const assortmentEl = $('assortment'); const designerEl = $('designer'); const seasonEl = $('season'); const collectionEl = $('collection'); const previewEl = $('preview'); const refreshBtn = $('refresh'); const createBtn = $('create'); const logBody = $('logBody');
    const newUserBtn = $('newUserBtn'); const signupDialog = $('signupDialog'); const suUser = $('suUser'); const suFirst = $('suFirst'); const suLast = $('suLast'); const suError = $('suError'); const suNext = $('suNext');
    const loginDialog = $('loginDialog'); const loginUserEl = $('loginUser'); const loginPassEl = $('loginPass'); const loginError = $('loginError'); const loginSubmit = $('loginSubmit');
    const setPwdDialog = $('setPwdDialog'); const newPwd = $('newPwd'); const newPwd2 = $('newPwd2'); const setPwdError = $('setPwdError'); const setPwdSave = $('setPwdSave');
    const authBtn = $('authBtn'); const authLabel = $('authLabel'); const openAdmin = $('openAdmin'); const adminList = $('adminList'); const loggedBadge = $('loggedBadge');

    // ===== THEME (persist) =====
    const THEME_KEY='gh_theme_v1';
    function setTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      const light = t==='light';
      iconSun.style.display = light ? 'none' : '';
      iconMoon.style.display = light ? '' : 'none';
      themeLabel.textContent = light ? 'Dark' : 'Light';
      localStorage.setItem(THEME_KEY, t);
    }
    function initTheme(){
      const saved = localStorage.getItem(THEME_KEY);
      if(saved==='light' || saved==='dark'){ setTheme(saved); }
      else {
        // prefer-color-scheme jako start
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        setTheme(prefersDark ? 'dark' : 'light');
      }
    }
    themeBtn.addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(cur==='dark' ? 'light' : 'dark');
    });

    // ===== UTIL =====
    const pad3 = n => String(n).padStart(3,'0');
    const sha256Hex = async (text)=>{ const enc = new TextEncoder().encode(text); const buf = await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); };
    const showToast = (m)=>{ if(!toast) return; toast.textContent = m; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.classList.remove('show'),1600); };

    // ===== PERSIST AUTH (trwałe logowanie) =====
    const AUTH_KEY = 'gh_auth_v1';
    const loadAuth = ()=>{ try{ return JSON.parse(localStorage.getItem(AUTH_KEY)) || {user:'',role:''}; }catch{ return {user:'',role:''}; } };
    const saveAuth = (auth)=>{ localStorage.setItem(AUTH_KEY, JSON.stringify(auth)); };
    let AUTH = loadAuth();

    // ===== Konfiguracja i inicjalizacja Firebase =====
    const firebaseConfig = window.__FIREBASE_CONFIG__ || {};
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    envBadge.textContent = 'ENV: FIREBASE (online, współdzielone — realtime)';

    // ===== MAPPINGI =====
    const BRAND_MAP = { ES:'Esotiq', HE:'Henderson', BV:'Bloovii', HL:'Henderson Ladies' };
    const ASSORTMENT_MAP = { PR:'PRINT', PT:'PATTERN', EM:'EMBROIDERY', RB:'RUBBER', TP:'TAPE', AP:'APPLICATION', LB:'LABEL', HG:'HANGTAG', BX:'BOX', PC:'SOCKS PACKING', ST:'PRICE STICKER', FAN:'MISCELLANEOUS', BT:'BUTTON', HAN:'HANGER PRINT', WCL:'WASHING LABEL' };

    // ===== Kolekcje / dokumenty =====
    const usersCol = collection(db, 'users');
    const codesCol = collection(db, 'codes');
    const countersDoc = doc(db, 'meta', 'counters');

    // ===== UI AUTH =====
    function updateAuthUI(){
      const logged = !!AUTH.user;
      authLabel.textContent = logged ? 'Wyloguj' : 'Zaloguj';
      openAdmin.style.display = AUTH.role==='admin' ? 'inline-flex' : 'none';
      if (designerEl){
        designerEl.innerHTML = logged && AUTH.role==='user' ? `<option>${AUTH.user}</option>` : '<option value="">— niezalogowano —</option>';
        designerEl.disabled = true;
      }
      if (loggedBadge){
        if (logged) { loggedBadge.style.display='inline-flex'; loggedBadge.textContent = `Zalogowany: ${AUTH.user}${AUTH.role==='admin'?' (admin)':''}`; }
        else { loggedBadge.style.display='none'; loggedBadge.textContent=''; }
      }
    }

    // ===== Realtime: Users =====
    function subscribeUsers(){
      const qUsers = query(usersCol, orderBy('id'));
      onSnapshot(qUsers, snap=>{
        const arr = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        loginUserEl.innerHTML = arr.map(u=>`<option value="${u.id}">${u.id}</option>`).join('') + '<option value="administrator">administrator</option>';

        if (arr.length === 0) {
          (async ()=>{
            const seed = ['Ania','Grzegorz','Kuba','Łukasz','Olga','Rafał'];
            for (const u of seed) {
              await setDoc(doc(db,'users',u), { id:u, first:'', last:'', pass:'', forceReset:true, role:'user', createdAt: serverTimestamp() });
            }
            await setDoc(doc(db,'users','administrator'), { id:'administrator', first:'Admin', last:'Root', pass:'', forceReset:false, role:'admin', createdAt: serverTimestamp() });
          })().catch(console.error);
        }
      }, err => console.error('users onSnapshot error', err));
    }

    // ===== Realtime: Codes =====
    function toJsDate(ts){
      if (!ts) return new Date();
      if (typeof ts.toDate === 'function') return ts.toDate();
      if (typeof ts === 'number') return new Date(ts);
      if (typeof ts === 'string') return new Date(ts);
      return new Date();
    }

    function subscribeCodes(){
      const qCodes = query(codesCol, orderBy('createdAt', 'asc'));
      onSnapshot(qCodes, snap=>{
        const arr = snap.docs.map(d=> d.data());
        logBody.innerHTML='';
        arr.slice().reverse().forEach(item=>{
          const tr=document.createElement('tr');
          const dt = toJsDate(item.createdAt);
          tr.innerHTML = `<td><strong>${item.code}</strong></td>
            <td>${ASSORTMENT_MAP[item.assortment]||item.assortment}</td>
            <td>${BRAND_MAP[item.brand]||item.brand}</td>
            <td>${item.season}</td>
            <td>${item.designer}</td>
            <td>${item.collection||''}</td>
            <td>${dt.toLocaleString()}</td>`;
          logBody.appendChild(tr);
        });
      }, err => console.error('codes onSnapshot error', err));
    }

    // ===== Sezony =====
    function buildSeasons(){
      const now = new Date();
      const y = now.getFullYear();
      const years=[y,y+1,y+2];
      const opts=[];
      years.forEach(yr=>{ opts.push(`SS${yr}`); opts.push(`AW${yr}`); });
      seasonEl.innerHTML = opts.map(s=>`<option>${s}</option>`).join('');
      const defaultSeason = (now.getMonth()>=8) ? `AW${y}` : `SS${y}`;
      seasonEl.value = defaultSeason;
    }

    // ===== Podgląd kodu (orientacyjny) =====
    async function computePreview(){
      const a = assortmentEl.value; const b = brandEl.value;
      previewEl.textContent = `${a}_${b}…`; // finalny numer nada transakcja
    }

    // ===== Transakcja licznika + zapis kodu =====
    async function createCode(){
      if(!AUTH.user || AUTH.role!=='user'){ alert('Zaloguj się jako projektant/ka.'); return; }
      const a = assortmentEl.value; const b = brandEl.value; const s = seasonEl.value; const coll = (collectionEl.value||'').trim();

      const seq = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(countersDoc);
        const data = snap.exists() ? snap.data() : {};
        const key = `${a}_${b}`;
        const next = Number(data[key]||0) + 1;
        tx.set(countersDoc, Object.assign({}, data, { [key]: next }));
        return next;
      });

      const code = `${a}_${b}${pad3(seq)}`;
      const entry = { code, assortment:a, brand:b, season:s, designer:AUTH.user, collection:coll, createdAt: serverTimestamp() };
      await addDoc(codesCol, entry);

      await computePreview();
      showToast('Utworzono: '+code);
      try{ await navigator.clipboard.writeText(code); }catch{}
    }

    // ===== FLOW: Signup (popup) =====
    const validUsername = (u)=> /^[a-z][a-z0-9_.\-]{2,31}$/i.test(u);
    newUserBtn.addEventListener('click', ()=>{
      suError.style.display='none'; suUser.value=''; suFirst.value=''; suLast.value='';
      signupDialog.showModal(); suUser.focus();
    });

    suNext.addEventListener('click', async ()=>{
      const id = suUser.value.trim();
      const first = suFirst.value.trim();
      const last = suLast.value.trim();

      if(!validUsername(id)){
        suError.textContent='Użyj formatu nazwy: litera na start, 3–32 znaki (litery/cyfry . _ -)';
        suError.style.display='block'; return;
      }
      if(first.length===0 || last.length===0){
        suError.textContent='Imię i nazwisko są obowiązkowe.';
        suError.style.display='block'; return;
      }
      try{
        const ref = doc(db, 'users', id);
        const s = await getDoc(ref);
        if (s.exists()) { suError.textContent='Taki użytkownik już istnieje.'; suError.style.display='block'; return; }
        await setDoc(ref, { id, first, last, pass:'', forceReset:true, role:'user', createdAt: serverTimestamp() });
        signupDialog.close();
        setPwdDialog.dataset.pendingUser = id; newPwd.value=''; newPwd2.value=''; setPwdError.style.display='none'; setPwdDialog.showModal();
      } catch(e){
        suError.textContent = 'Nie udało się utworzyć użytkownika.'; suError.style.display='block';
      }
    });

    // ===== FLOW: Login / Password =====
    function setLoggedIn(u, role){ AUTH={user:u, role}; saveAuth(AUTH); updateAuthUI(); showToast('Zalogowano.'); }
    function setLoggedOut(){ AUTH={user:'', role:''}; saveAuth(AUTH); updateAuthUI(); showToast('Wylogowano.'); }

    authBtn.addEventListener('click', ()=>{
      if(AUTH.user){ setLoggedOut(); return; }
      loginError.style.display='none'; loginPassEl.value=''; loginDialog.showModal();
    });

    loginSubmit.addEventListener('click', async ()=>{
      const id = loginUserEl.value; const pass = loginPassEl.value;
      if (id === 'administrator'){
        if (pass === 'mars'){ loginDialog.close(); setLoggedIn(id,'admin'); }
        else { loginError.style.display='block'; }
        return;
      }
      const s = await getDoc(doc(db,'users',id));
      if(!s.exists()){ loginError.style.display='block'; return; }
      const u = s.data();
      if (u.forceReset){
        if (pass === 'Atlas123'){
          loginDialog.close();
          setPwdDialog.dataset.pendingUser = id; newPwd.value=''; newPwd2.value=''; setPwdError.style.display='none'; setPwdDialog.showModal();
        } else {
          loginError.style.display='block';
        }
        return;
      }
      const hash = await sha256Hex(pass);
      if (u.pass === hash){
        loginDialog.close(); setLoggedIn(id,'user');
      } else {
        loginError.style.display='block';
      }
    });

    setPwdSave.addEventListener('click', async ()=>{
      const u = setPwdDialog.dataset.pendingUser||'';
      const p1 = newPwd.value; const p2 = newPwd2.value;
      if (p1.length<8 || p1!==p2){ setPwdError.textContent='Hasła muszą być identyczne i mieć min. 8 znaków.'; setPwdError.style.display='block'; return; }
      const hash = await sha256Hex(p1);
      await updateDoc(doc(db,'users',u), { pass: hash, forceReset:false });
      setPwdDialog.close();
      setLoggedIn(u,'user');
    });

    // ===== ADMIN (reset hasła) =====
    openAdmin.addEventListener('click', async ()=>{
      const userOpts = loginUserEl.innerHTML || '';
      adminList.innerHTML = userOpts
        .replaceAll('<option','<span class="chip" data-u')
        .replaceAll('</option>','</span>')
        .replaceAll('value="','')
        .replaceAll('">','</span>')
        .trim();
      adminList.querySelectorAll('[data-u]').forEach(span=>{
        const user = span.textContent.trim();
        if(!user || user==='administrator'){ span.remove(); return; }
        span.innerHTML = `<strong>${user}</strong> <button class="btn" data-reset="${user}">Reset</button>`;
      });
      $('adminDialog').showModal();
    });

    adminList.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-reset]');
      if(!btn) return;
      const who = btn.getAttribute('data-reset');
      await updateDoc(doc(db,'users',who), { pass:'', forceReset:true });
      showToast('Zresetowano hasło: '+who);
    });

    // ===== Sezony / Podgląd / Subskrypcje =====
    function buildSeasonsAndPreview(){
      buildSeasons();
      computePreview();
      brandEl.addEventListener('change', computePreview);
      assortmentEl.addEventListener('change', computePreview);
      refreshBtn.addEventListener('click', computePreview);
    }

    // ===== Utwórz kod =====
    createBtn.addEventListener('click', createCode);

    // ===== Dialog zamykanie =====
    document.querySelectorAll('dialog [data-close]').forEach(b=> b.addEventListener('click', e=> e.target.closest('dialog').close()));

    // ===== Eye toggles (jedna ikona, zmienia się) =====
    function toggleEye(btn, visible){
      const svgClosed = btn.querySelector('svg[data-eye="closed"]');
      const svgOpen = btn.querySelector('svg[data-eye="open"]');
      if(!svgClosed || !svgOpen) return;
      svgClosed.style.display = visible ? 'none' : '';
      svgOpen.style.display   = visible ? '' : 'none';
    }
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.pw-toggle'); if(!btn) return;
      const id = btn.getAttribute('data-target'); const inp = document.getElementById(id);
      if(!inp) return;
      const nowVisible = (inp.type === 'password');
      inp.type = nowVisible ? 'text' : 'password';
      toggleEye(btn, nowVisible);
    });

    // ===== Init =====
    (function init(){
      initTheme();
      buildSeasonsAndPreview();
      subscribeUsers();
      subscribeCodes();
      updateAuthUI();

      // pokaż login tylko jeśli nie byliśmy zalogowani
      const wasLogged = !!AUTH.user;
      if(!wasLogged && !sessionStorage.getItem('login_demo_shown')){
        sessionStorage.setItem('login_demo_shown','1');
        loginDialog.showModal();
      }
    })();
  </script>
</body>
</html>
